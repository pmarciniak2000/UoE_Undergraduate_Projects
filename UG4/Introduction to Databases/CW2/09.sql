select cast(t1.custid as int), max(t1.cname) as name, cast(max(t1.orders)+1 as int) as totalorders from (select c.custid, c.cname,count(o.ordid) as orders, count(distinct o.odate) as distinctdays, (min(o1.odate)-o.odate) as datedifference from customers c join orders o on c.custid=o.ocust join orders o1 on (c.custid=o1.ocust and o.odate != o1.odate and o1.odate>o.odate) where c.custid in (select c.custid from customers c join orders o on c.custid=o.ocust group by c.custid having count(distinct o.odate)>=count(o.ordid) and count(o.ordid)>=10 order by c.custid) group by c.custid, o.odate) as t1 group by t1.custid having avg(t1.datedifference)<7 order by t1.custid;
